#!/usr/bin/env python3

import os
import http.server
import ssl
import socket

def find_free_port():
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        s.bind(('', 0))
        s.listen(1)
        port = s.getsockname()[1]
    return port

def generate_self_signed_cert():
    cert_path = os.path.expanduser('~/.local/share/pweb')
    os.makedirs(cert_path, exist_ok=True)
    cert_file = os.path.join(cert_path, 'cert.pem')
    key_file = os.path.join(cert_path, 'key.pem')
    
    # Check if certificates already exist
    if not (os.path.exists(cert_file) and os.path.exists(key_file)):
        os.system(f'openssl req -x509 -newkey rsa:4096 -keyout {key_file} -out {cert_file} -days 365 -nodes -subj "/CN=localhost"')
    
    return cert_file, key_file

def main():
    port = find_free_port()
    cert_file, key_file = generate_self_signed_cert()
    
    current_dir = os.getcwd()
    
    print(f"**Starting HTTPS server in {current_dir}**")
    print(f"**Serving on https://localhost:{port}**")

    httpd = http.server.HTTPServer(('0.0.0.0', port), http.server.SimpleHTTPRequestHandler)
    context = ssl.SSLContext(ssl.PROTOCOL_TLS_SERVER)
    context.load_cert_chain(certfile=cert_file, keyfile=key_file)
    httpd.socket = context.wrap_socket(httpd.socket, server_side=True)
    
    try:
        httpd.serve_forever()
    except KeyboardInterrupt:
        print("\n**Server stopped**")

if __name__ == '__main__':
    main()

